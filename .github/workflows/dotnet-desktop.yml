name: .NET Core Desktop

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:

  build:

    strategy:
      matrix:
        configuration: [Release]  # 只构建 Release 版本用于打包

    runs-on: windows-latest

    env:
      Solution_Name: WpfApp2.sln
      Project_Name: WpfApp2
      Project_Path: WpfApp2\WpfApp2.csproj
      InnoSetup_Script: iss/installer.iss
      Setup_Output_Dir: SetupOutput
      App_Version: 2.0.1.${{ github.run_number }}
      App_Exe_Name: lanpingcj.exe

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 设置 .NET Core
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # 设置 MSBuild
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # 恢复 NuGet 包
    - name: Restore NuGet packages
      run: dotnet restore $env:Solution_Name

    # 执行单元测试
    - name: Run unit tests
      run: dotnet test $env:Solution_Name --verbosity normal

    # 构建应用程序
    - name: Build application
      run: |
        msbuild $env:Solution_Name `
          /p:Configuration=${{ matrix.configuration }} `
          /p:Platform="Any CPU" `
          /p:OutputPath=bin\${{ matrix.configuration }} `
          /p:AssemblyVersion=${{ env.App_Version }} `
          /p:FileVersion=${{ env.App_Version }} `
          /p:Version=${{ env.App_Version }}

    # 发布应用程序（单文件发布）
    - name: Publish application
      run: |
        dotnet publish $env:Project_Path `
          -c ${{ matrix.configuration }} `
          -r win-x64 `
          --self-contained false `
          /p:PublishSingleFile=true `
          /p:IncludeNativeLibrariesForSelfExtract=true `
          /p:PublishReadyToRun=false `
          /p:DebugType=None `
          /p:DebugSymbols=false `
          -o Publish
          
        # 重命名可执行文件（如果需要）
        

    # 验证发布文件
    - name: Verify published files
      run: |
        Write-Host "发布文件夹内容:"
        Get-ChildItem -Path Publish -Recurse | Format-Table -Property Name, Length, LastWriteTime
        
        Write-Host "主程序文件:"
        Get-ChildItem -Path "Publish\${{ env.App_Exe_Name }}" | Format-List

    # 使用 Inno Setup 插件编译安装程序
    - name: Inno Setup Action
      uses: Minionguyjpro/Inno-Setup-Action@v1.2.7
      with:
        # ISS 脚本路径
        script: ${{ env.InnoSetup_Script }}
        # 输出选项
        options: /O${{ env.Setup_Output_Dir }} /F${{ env.Project_Name }}_Setup_${{ env.App_Version }}
        # 编译时使用的定义
        defines: |
          Configuration=${{ matrix.configuration }}
          ProjectName=${{ env.Project_Name }}
          AppVersion=${{ env.App_Version }}
          MyAppExeName=${{ env.App_Exe_Name }}
          BuildDate=${{ github.event.head_commit.timestamp }}
          CommitHash=${{ github.sha }}
        # 工作目录
        working-directory: .

    # 验证生成的安装程序
    - name: Verify generated setup
      run: |
        Write-Host "生成的安装程序文件:"
        Get-ChildItem -Path $env:Setup_Output_Dir -Recurse | Format-Table -Property Name, Length, LastWriteTime
        
        # 检查安装程序文件大小
        $setupFiles = Get-ChildItem -Path $env:Setup_Output_Dir -Filter "*.exe" -Recurse
        foreach ($file in $setupFiles) {
          Write-Host "安装程序: $($file.Name), 大小: $([math]::Round($file.Length / 1MB, 2)) MB"
        }

    # 上传构建产物
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.Project_Name }}-${{ matrix.configuration }}-${{ github.run_number }}
        path: |
          Publish
          ${{ env.Setup_Output_Dir }}
        retention-days: 30

    # 创建 GitHub 发布（可选，仅在创建标签时运行）
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ env.Setup_Output_Dir }}/*.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}