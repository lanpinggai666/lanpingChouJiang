name: 蓝屏抽奖机 - 四种分发版本

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    strategy:
      matrix:
        variant: 
          - name: PortableSingleFile
            publish_single_file: true
            self_contained: false
            output_suffix: 便携单文件版
          - name: FullSingleFile
            publish_single_file: true
            self_contained: true
            output_suffix: 完整单文件版
          - name: PortableSetup
            publish_single_file: false
            self_contained: false
            output_suffix: 便携框架版
          - name: FullSetup
            publish_single_file: false
            self_contained: true
            output_suffix: 完整框架版

    runs-on: windows-latest

    env:
      Solution_Name: WpfApp2.sln
      Project_Name: WpfApp2
      Project_Path: WpfApp2\WpfApp2.csproj
      InnoSetup_Script: iss/installer.iss
      Setup_Output_Dir: Output/Setups
      Publish_Dir: Output/${{ matrix.variant.name }}
      App_Version: 2.0.1.${{ github.run_number }}
      App_Exe_Name: lanpingcj.exe

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore and Build
      run: |
        dotnet restore $env:Solution_Name
        dotnet build $env:Solution_Name -c Release --no-restore

    - name: Publish Application (${{ matrix.variant.output_suffix }})
      run: |
        dotnet publish $env:Project_Path `
          -c Release `
          -r win-x64 `
          --self-contained ${{ matrix.variant.self_contained }} `
          /p:PublishSingleFile=${{ matrix.variant.publish_single_file }} `
          /p:IncludeNativeLibrariesForSelfExtract=true `
          /p:PublishReadyToRun=false `
          -o ${{ env.Publish_Dir }}
        
        Write-Host "✅ 发布完成: ${{ env.Publish_Dir }}"
        Get-ChildItem -Path ${{ env.Publish_Dir }} | Format-Table Name, Length

    - name: Copy Required Files to ISS Directory
      run: |
        # 复制ISS脚本所需的外部文件
        $filesToCopy = @("LICENSE-2.0.txt", "update.txt", "icon.ico")
        foreach ($file in $filesToCopy) {
          if (Test-Path $file) {
            Copy-Item -Path $file -Destination "iss\" -Force
            Write-Host "✓ 已复制: $file"
          } else {
            Write-Warning "⚠️ 文件不存在: $file"
          }
        }

    - name: Install Inno Setup
      run: |
        if (-not (Get-Command iscc -ErrorAction SilentlyContinue)) {
          $installerPath = "$env:TEMP\innosetup.exe"
          Invoke-WebRequest -Uri "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe" -OutFile $installerPath
          Start-Process -Wait -FilePath $installerPath -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -NoNewWindow
          echo "${env:ProgramFiles(x86)}\Inno Setup 6" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        }
        Write-Host "✅ Inno Setup 已就绪"

    - name: Create Setup Installer (${{ matrix.variant.output_suffix }})
      if: |
        matrix.variant.name == 'PortableSetup' || 
        matrix.variant.name == 'FullSetup'
      run: |
        # 创建输出目录
        New-Item -ItemType Directory -Force -Path ${{ env.Setup_Output_Dir }}
        
        # 计算相对路径（从iss目录到发布目录）
        $publishDirRelative = "..\${{ env.Publish_Dir }}"
        
        # 编译安装程序
        iscc "${{ env.InnoSetup_Script }}" `
          /O"${{ env.Setup_Output_Dir }}" `
          /F"蓝屏抽奖机_${{ matrix.variant.output_suffix }}_${{ env.App_Version }}" `
          /DMyAppVersion="${{ env.App_Version }}" `
          /DConfiguration="Release" `
          /DVariantName="${{ matrix.variant.name }}" `
          /DPublishDir="$publishDirRelative" `
          /DSelfContained="${{ matrix.variant.self_contained }}" `
          /DPublishSingleFile="${{ matrix.variant.publish_single_file }}"
        
        Write-Host "✅ 安装程序已创建"
        Get-ChildItem -Path ${{ env.Setup_Output_Dir }} -Filter "*.exe" | Format-Table Name, Length

    - name: Upload Artifacts (${{ matrix.variant.output_suffix }})
      uses: actions/upload-artifact@v4
      with:
        name: 蓝屏抽奖机_${{ matrix.variant.output_suffix }}_${{ env.App_Version }}
        path: |
          ${{ env.Publish_Dir }}
          ${{ env.Setup_Output_Dir }}/蓝屏抽奖机_${{ matrix.variant.output_suffix }}_${{ env.App_Version }}.exe
        retention-days: 30