name: 蓝屏抽奖机 - 安装程序打包

on:
  push:
    branches: [ "master" ]

jobs:
  build-and-package:
    strategy:
      matrix:
        variant: 
          - name: PortableSetup
            publish_single_file: true
            self_contained: false
            output_suffix: 便携版
          - name: FullSetup
            publish_single_file: true
            self_contained: true
            output_suffix: 完整版

    runs-on: windows-latest

    env:
      Solution_Name: WpfApp2.sln
      Project_Name: WpfApp2
      Project_Path: WpfApp2\WpfApp2.csproj
      InnoSetup_Script: iss/installer.iss
      App_Version: 2.0.1.${{ github.run_number }}
      App_Exe_Name: lanpingcj.exe

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Restore and Build
      run: |
        dotnet restore $env:Solution_Name
        dotnet build $env:Solution_Name -c Release --no-restore

    - name: Publish for Setup
      run: |
        # 清理并创建发布目录
        $publishDir = "Publish\${{ matrix.variant.name }}"
        if (Test-Path $publishDir) {
          Remove-Item -Path $publishDir -Recurse -Force
        }
        
        dotnet publish $env:Project_Path `
          -c Release `
          -r win-x64 `
          --self-contained ${{ matrix.variant.self_contained }} `
          /p:PublishSingleFile=${{ matrix.variant.publish_single_file }} `
          /p:IncludeNativeLibrariesForSelfExtract=true `
          /p:PublishReadyToRun=false `
          /p:DebugType=None `
          /p:DebugSymbols=false `
          -o $publishDir
        
        Write-Host "✅ 发布完成: $publishDir"
        Write-Host "文件列表:"
        Get-ChildItem -Path $publishDir | Format-Table Name, Length

    - name: Install Inno Setup
      run: |
        if (-not (Get-Command iscc -ErrorAction SilentlyContinue)) {
          $installerPath = "$env:TEMP\innosetup.exe"
          Invoke-WebRequest -Uri "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe" -OutFile $installerPath
          Start-Process -Wait -FilePath $installerPath -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -NoNewWindow
          echo "${env:ProgramFiles(x86)}\Inno Setup 6" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        }
        Write-Host "✅ Inno Setup 已就绪"

    - name: Prepare ISS Files
      run: |
        # 确保ISS目录存在
        if (-not (Test-Path "iss")) {
          New-Item -ItemType Directory -Force -Path "iss"
        }
        
        # 复制ISS脚本需要的文件
        $filesToCopy = @("LICENSE-2.0.txt", "update.txt", "icon.ico")
        foreach ($file in $filesToCopy) {
          if (Test-Path $file) {
            Copy-Item -Path $file -Destination "iss\" -Force
            Write-Host "✓ 已复制: $file"
          } else {
            Write-Warning "⚠️ 文件不存在: $file"
          }
        }

    - name: Compile Setup (${{ matrix.variant.output_suffix }})
      run: |
        # 创建输出目录
        $setupDir = "Setups"
        New-Item -ItemType Directory -Force -Path $setupDir
        
        # 编译安装程序
        iscc "${{ env.InnoSetup_Script }}" `
          /O"$setupDir" `
          /F"蓝屏抽奖机_${{ matrix.variant.output_suffix }}_${{ env.App_Version }}" `
          /DMyAppVersion="${{ env.App_Version }}" `
          /DConfiguration="Release" `
          /DVariantName="${{ matrix.variant.name }}" `
          /DPublishDir="..\Publish\${{ matrix.variant.name }}" `
          /DSelfContained="${{ matrix.variant.self_contained }}" `
          /DPublishSingleFile="${{ matrix.variant.publish_single_file }}"
        
        Write-Host "✅ 安装程序已创建"
        Get-ChildItem -Path $setupDir -Filter "*.exe" | Format-Table Name, Length

    - name: Upload Setup Artifact
      uses: actions/upload-artifact@v4
      with:
        name: 蓝屏抽奖机_${{ matrix.variant.output_suffix }}_${{ env.App_Version }}
        path: Setups/蓝屏抽奖机_${{ matrix.variant.output_suffix }}_${{ env.App_Version }}.exe
        retention-days: 30